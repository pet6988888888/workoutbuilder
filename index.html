<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-Week Workout Challenge Builder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        // Define Tailwind Configuration with custom colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#111827',     // Darkest background
                        'secondary-dark': '#1f2937',   // Card/Cell background
                        'accent-teal': '#14b8a6',      // Teal for primary actions/highlights
                        'accent-cyan': '#06b6d4',      // Cyan for secondary highlights
                        'light-text': '#f3f4f6',       // Light text color
                    },
                }
            }
        }
    </script>


<script type="text/javascript">
        // Define storage keys and constants
        const PLAN_STORAGE_KEY = 'workoutChallengePlan';
        const CHALLENGE_TITLE_KEY = 'workoutChallengeTitle'; // New Key
        const DAILY_STATUS_KEY = 'workoutChallengeDailyStatus'; // New Key
        const DAYS_IN_CHALLENGE = 28;
        // Updated REST WORKOUT ID to match the newly generated full list (w18)
        const REST_WORKOUT_ID = 'w18'; 
        const WARM_UP_ID = 'w16'; // Constant for Warm Up
        const COOL_DOWN_ID = 'w17'; // Constant for Cool Down
        const DEFAULT_THUMBNAIL_URL = 'https://placehold.co/80x80/6B7280/FFFFFF?text=W'; // Placeholder image for lists
        const DEFAULT_LARGE_IMAGE_URL = 'https://placehold.co/400x300/6B7280/FFFFFF?text=GUIDE+IMAGE'; // Placeholder for large images


        // Application State
        let challengePlan = Array.from({ length: DAYS_IN_CHALLENGE }, () => []); 
        let challengeTitle = '4-Week Home Workout Challenge'; // Default title
        let dailyStatus = Array.from({ length: DAYS_IN_CHALLENGE }, () => 'unplanned'); // 'unplanned', 'completed', 'skipped'
        let currentDayIndex = null; 
        let selectedFilter = 'All'; 
        let selectedWorkoutsInModal = []; 
        let expandedWorkoutId = null; 
        
        // --- START OF FULL WORKOUT DATA (17 ACTIVE + 1 REST = 18 ENTRIES) ---
        const DEFAULT_WORKOUTS = [
            // --- BEGINNER WORKOUTS (w1 - w5) ---
            { 
                id: 'w1', name: 'Beginner HIWT', type: 'HIWT', difficulty: 'Beginner', duration: '30 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=B1', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=B+HIWT', 
                description: 'Beginner-friendly high-intensity interval weight training using simple movements (squats, push-ups) with controlled pacing.\nFocus on learning the format and building confidence.', 
                structure: '4 combos (2 exercises each).\n20s work / 10s rest, repeated 2 rounds per combo.\n45s rest between combos.\nFocus on form over speed.', 
                tips: 'If fatigued, pause for 5-10 seconds and continue.\nFocus on smooth, controlled movement.', focus: 'General Fitness, Endurance', 
                exercises: ['Bodyweight Squat', 'Push-up', 'Reverse Lunge', 'Dumbbell Row'] 
            },
            { 
                id: 'w2', name: 'Beginner HIIT', type: 'HIIT', difficulty: 'Beginner', duration: '20 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=B2', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=B+HIIT', 
                description: 'A short, purely cardiovascular bodyweight routine to build anaerobic base fitness.\nFocuses on low-impact movements with high repetition count.', 
                structure: '4 rounds of 3 exercises (30s work / 15s rest).\n45s rest between rounds.\nExercises: Jumping Jacks, High Knees (low impact), Mountain Climbers.', 
                tips: 'Keep movement continuous.\nMinimize jump height if needed.\nFocus on steady, deep breaths.', focus: 'Cardio, Weight Loss',
                exercises: ['Jumping Jacks', 'High Knees', 'Mountain Climbers']
            },
            { 
                id: 'w3', name: 'Beginner Core', type: 'CORE', difficulty: 'Beginner', duration: '15 min', 
                thumbnailImage: 'https://placehold.co/80x80/f3f4f6/111827?text=B3', 
                documentImage: 'https://placehold.co/400x300/f3f4f6/111827?text=B+CORE', 
                description: 'A gentle full-core routine focusing on basic static holds (Plank, Side Plank, Bridge) to introduce proper core bracing and stabilization.', 
                structure: '3 static exercises.\nHold each for 45s.\nComplete 2 rounds with 30s rest between rounds.', 
                tips: 'Maintain a straight line from head to heels.\nEngage your glutes.\nDo not let your lower back sag.', focus: 'Core Strength',
                exercises: ['Plank Hold', 'Side Plank', 'Glute Bridge Hold']
            },
            { 
                id: 'w4', name: 'Beginner Abs', type: 'ABS', difficulty: 'Beginner', duration: '15 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=B4', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=B+ABS', 
                description: 'An introduction to dynamic abdominal movements (crunches, leg slides) focusing on muscle contraction and range of motion, rather than speed.', 
                structure: '3 exercises (Crunches, Leg Slides, Reverse Crunches).\n15 reps each.\nComplete 3 sets with 30s rest between sets.', 
                tips: 'Use slow, controlled reps.\nKeep chin tucked and avoid pulling on your neck.', focus: 'Core Definition',
                exercises: ['Crunches', 'Leg Slides', 'Reverse Crunches']
            },
            { 
                id: 'w5', name: 'Beginner Muscle Building', type: 'MUSCLE BUILDING', difficulty: 'Beginner', duration: '45 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=M1', 
                documentImage: 'https://raw.githubusercontent.com/pet6988888888/images/refs/heads/main/4%20Week%20Challenge%20Beginner%20(1).png', 
                description: 'For your MUSCLE BUILDING workout, you will do a GVT (German Volume Training) full body workout. You will perform 10 sets of 10 reps with only 10 seconds of rest between each rep for each of the 5 exercises (this is why these workouts are also sometimes known as the 10 x 10 x 10 workouts). You will rest 1–3 minutes between each exercise and continue until you have completed all 5 exercises. If 10 x 10 x 10 is too hard for you, you can start by doing only 5 sets, so 10 x 10 x 5. If you need more rest, you can take it at any stage during the workout and simply continue when you are ready. Try to improve by resting less with each workout and using harder exercises over time.', 
                structure: `
        <ul>
            <li>KNEE PUSH-UP – (10 reps x 10 sec rest) x 5 sets</li>
            <li>BENT OVER ROW – (10 reps x 10 sec rest) x 5 sets</li>
            <li>SHOULDER PRESS – (10 reps x 10 sec rest) x 5 sets</li>
            <li>SQUAT – (10 reps x 10 sec rest) x 5 sets</li>
            <li>BRIDGE – (10 reps x 10 sec rest) x 5 sets</li>
        </ul>
    `, 
                tips: `
        <ul>
            <li>Use harder or easier exercises, or heavier and lighter dumbbells to match your level.</li>
            <li>Increase the number of sets if the workout feels too easy.</li>
            <li>Take 1 to 3 minutes of rest between sets to recover properly before continuing.</li>
        </ul>
    `,  focus: 'Muscle Building, Hypertrophy',
                exercises: ['Bodyweight Squat', 'Push-up', 'Dumbbell Row', 'Forward Lunge', 'Overhead Press']
            },
            
            // --- INTERMEDIATE WORKOUTS (w6 - w10) ---
            { 
                id: 'w6', name: 'Intermediate HIWT', type: 'HIWT', difficulty: 'Intermediate', duration: '40 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=I1', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=I+HIWT', 
                description: 'A challenging high-intensity workout using minimal equipment.\nUses 20/10 intervals alternating between two compound movements (e.g., Goblet Squat and Push Press) to build strength endurance.', 
                structure: '5 Combos of 4 rounds each (20s work / 10s rest).\n60s rest between combos.', 
                tips: 'Keep intensity high during the work periods.\nPrioritize form over speed when lifting.', focus: 'Weight Loss, Strength Endurance',
                exercises: ['Goblet Squat', 'Push Press', 'Kettlebell Swing', 'Renegade Row', 'Burpee']
            },
            { 
                id: 'w7', name: 'Intermediate HIIT', type: 'HIIT', difficulty: 'Intermediate', duration: '30 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=I2', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=I+HIIT', 
                description: 'A pure, fast-paced cardio blast using bodyweight movements (burpees, squat jumps) to maximize calorie burn and improve anaerobic fitness.', 
                structure: '6 rounds of 4 exercises (40s work / 20s rest).\n60s rest between rounds.\nMaximize jumps and speed.', 
                tips: 'Go all-out during the work period.\nShort rest is for recovery, not cooling down.', focus: 'Weight Loss, Cardio',
                exercises: ['Burpee', 'Squat Jumps', 'High Knees', 'Plank Jacks']
            },
            { 
                id: 'w8', name: 'Intermediate Core', type: 'CORE', difficulty: 'Intermediate', duration: '20 min', 
                thumbnailImage: 'https://placehold.co/80x80/f3f4f6/111827?text=I3', 
                documentImage: 'https://placehold.co/400x300/f3f4f6/111827?text=I+CORE', 
                description: 'A core routine focused on anti-rotation and dynamic stability (e.g., plank variations, bird-dog, farmer carries).\nEssential for spinal health and heavy lifting.', 
                structure: '4 exercises.\n3 sets of 60s hold or 12-15 reps per side.\n30s rest between sets.', 
                tips: 'Keep the pelvis stable and level.\nFocus on deep, bracing breaths.', focus: 'Core Stability',
                exercises: ['Plank with Shoulder Taps', 'Bird Dog', 'Farmer Carry (Light Weight)', 'Side Plank Rotations']
            },
            { 
                id: 'w9', name: 'Intermediate Abs', type: 'ABS', difficulty: 'Intermediate', duration: '20 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=I4', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=I+ABS', 
                description: 'A circuit of dynamic movements (e.g., V-ups, Bicycle Crunches, Russian Twists) focusing on defining the upper/lower abs and obliques.', 
                structure: '4 dynamic exercises.\n30s work / 10s rest.\nComplete 5 rounds.\nNo rest between rounds.', 
                tips: 'Ensure proper spinal flexion (curling).\nFocus on squeezing your core muscles to initiate the movement.', focus: 'Core Definition',
                exercises: ['V-ups', 'Bicycle Crunches', 'Russian Twists', 'Flutter Kicks']
            },
            { 
                id: 'w10', name: 'Intermediate Muscle Building', type: 'MUSCLE BUILDING', difficulty: 'Intermediate', duration: '60 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=I5', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=I+MUSC', 
                description: 'This is either an Upper Body or Lower Body focused day using moderate weight and high volume (3-4 sets of 8-12 reps).\nRequires weights.', 
                structure: '4 main movements per session (e.g., Bench Press, Overhead Press, Bicep Curl, Tricep Extension for Upper Body).\n3 sets of 10 reps.\n75s rest between sets.', 
                tips: 'Increase the weight when you can comfortably complete all sets and reps.\nUse controlled negatives.', focus: 'Muscle Building, Hypertrophy',
                exercises: ['Dumbbell Bench Press', 'Overhead Press', 'Bicep Curl', 'Tricep Extension', 'Deadlift (Light)', 'Bulgarian Split Squat']
            },

            // --- ADVANCED WORKOUTS (w11 - w15) ---
            { 
                id: 'w11', name: 'Advanced HIWT', type: 'HIWT', difficulty: 'Advanced', duration: '50 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=A1', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=A+HIWT', 
                description: 'Advanced metabolic conditioning using complex compound movements (e.g., cleans, snatches, man-makers) in a high-density format (AMRAP or EMOM) to maximize fat burn and conditioning.', 
                structure: '5 rounds of an EMOM (Every Minute On the Minute) for 8 minutes.\nFocus on managing fatigue and maintaining power output.', 
                tips: 'Scale the weight or reps if form degrades.\nHydrate constantly.\nThis session is designed to be highly demanding.', focus: 'Fat Loss, Conditioning',
                exercises: ['Dumbbell Clean and Press', 'Man Makers', 'Box Jumps', 'Wall Balls']
            },
            { 
                id: 'w12', name: 'Advanced HIIT', type: 'HIIT', difficulty: 'Advanced', duration: '35 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=A2', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=A+HIIT', 
                description: 'An aggressive HIIT routine using plyometrics and explosive movements (e.g., box jumps, full burpees, sprints) with minimal recovery.\nMax effort required.', 
                structure: '8 Tabata rounds (20s work / 10s rest) for two different exercises, alternating between them for 8 minutes total.\nRepeat 2 circuits.', 
                tips: 'Treat the 20 seconds as a sprint.\nIf you cannot maintain maximum effort, lower the intensity or take a short pause.', focus: 'Anaerobic Fitness, Explosive Power',
                exercises: ['Burpee', 'Sprints (On Spot)', 'Explosive Push-ups', 'Lateral Jumps']
            },
            { 
                id: 'w13', name: 'Advanced Core', type: 'CORE', difficulty: 'Advanced', duration: '20 min', 
                thumbnailImage: 'https://placehold.co/80x80/f3f4f6/111827?text=A3', 
                documentImage: 'https://placehold.co/400x300/f3f4f6/111827?text=A+CORE', 
                description: 'Core training focused on heavy loaded movements (e.g., landmines, weighted carries, weighted crunches) to build absolute core strength and resilience.', 
                structure: '3 weighted exercises (Weighted Plank, Cable/Band Chops, Dumbbell Side Bends).\n4 sets of 10-15 reps/side or 60s hold.\nMaximize weight.', 
                tips: 'Use slow, deliberate movements.\nMaintain a neutral spine at all times to protect the lower back.', focus: 'Absolute Core Strength',
                exercises: ['Weighted Plank', 'Cable/Band Chops', 'Dumbbell Side Bends']
            },
            { 
                id: 'w14', name: 'Advanced Abs', type: 'ABS', difficulty: 'Advanced', duration: '25 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=A4', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=A+ABS', 
                description: 'A high-skill routine focused on lower abs and obliques, requiring a pull-up bar or sturdy anchor for hanging leg raises and advanced floor work.', 
                structure: '4 exercises (Hanging Leg Raises, Toes-to-Bar, Dragon Flags/Progression, Wood Choppers).\n3 sets to near failure for each.\n60s rest.', 
                tips: 'Focus on initiating the movement from the pelvis, not the hip flexors.\nControl the descent on hanging movements.', focus: 'Core Definition, Athleticism',
                exercises: ['Hanging Leg Raises', 'Toes-to-Bar', 'Dragon Flags', 'Wood Choppers']
            },
            { 
                id: 'w15', name: 'Advanced Muscle Building', type: 'MUSCLE BUILDING', difficulty: 'Advanced', duration: '60 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=A5', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=A+MUSC', 
                description: 'German Volume Training (GVT) protocol using high volume (10 sets of 10 reps) to promote significant muscular hypertrophy (growth).\nRequires dumbbells or resistance.', 
                structure: '2 main compound lifts (e.g., Squats, Bench Press).\n10 sets of 10 reps per lift.\nUse 60% of 1RM (1-rep max).\n90s rest between sets.', 
                tips: 'The goal is muscle failure near the end of the 10 sets.\nUse slow, controlled negative (lowering) movements.', focus: 'Muscle Building, Hypertrophy',
                exercises: ['Barbell Squat', 'Barbell Bench Press', 'Pull-ups', 'Barbell Row']
            },

            // --- UTILITY & RECOVERY WORKOUTS (w16 - w18) ---
            { 
                id: WARM_UP_ID, name: 'Warm Up', type: 'WARM UP', difficulty: 'Beginner', duration: '10 min', 
                thumbnailImage: 'https://placehold.co/80x80/22c55e/FFFFFF?text=WU', 
                documentImage: 'https://placehold.co/400x300/22c55e/FFFFFF?text=WARM+UP', 
                description: 'A dynamic mobility sequence to prepare the joints and muscles for the main workout.\nCrucial for injury prevention and maximizing performance.', 
                structure: '30s per movement: Arm Circles, Torso Twists, High Knees, Squat to Stand, Leg Swings (side/front).\nFocus on continuous movement.', 
                tips: 'Do not static stretch.\nMove through a comfortable range of motion.', focus: 'Mobility, Preparation',
                exercises: ['Arm Circles', 'Torso Twists', 'High Knees', 'Squat to Stand', 'Leg Swings']
            },
            { 
                id: COOL_DOWN_ID, name: 'Cool Down', type: 'COOL DOWN', difficulty: 'Beginner', duration: '10 min', 
                thumbnailImage: 'https://placehold.co/80x80/ef4444/FFFFFF?text=CD', 
                documentImage: 'https://placehold.co/400x300/ef4444/FFFFFF?text=COOL+DOWN', 
                description: 'A static stretching routine to lower the heart rate, remove metabolic waste, and begin the recovery process by increasing muscle length.', 
                structure: '45s hold per side: Quad Stretch, Hamstring Stretch, Pigeon Pose, Shoulder Stretch.\nFocus on deep breaths.', 
                tips: 'Hold each stretch without bouncing.\nStretch only to the point of mild tension.', focus: 'Recovery, Flexibility',
                exercises: ['Quad Stretch', 'Hamstring Stretch', 'Pigeon Pose', 'Shoulder Stretch']
            },
            { 
                id: REST_WORKOUT_ID, name: 'Rest Day', type: 'REST', difficulty: 'Beginner', duration: 'N/A', 
                thumbnailImage: 'https://placehold.co/80x80/6B7280/FFFFFF?text=REST', 
                documentImage: 'https://placehold.co/400x300/6B7280/FFFFFF?text=REST+DAY', 
                description: 'Full physical rest to allow muscles to repair and grow stronger.\nCrucial for recovery and injury prevention.\nThis includes optional light activities like Yoga, Sport, or Calisthenics Skills.', 
                structure: 'Focus on sleep, nutrition, and hydration.\nOptional: 15 minutes of light walking or foam rolling.', 
                tips: 'Avoid strenuous activity.\nPrioritize 7-9 hours of sleep.\nThis is when the gains happen!', focus: 'All',
                exercises: ['Light Walking', 'Foam Rolling']
            }
        ];
        
        // Workout data is loaded from the hardcoded list
        let customWorkouts = DEFAULT_WORKOUTS; 


        // --- Utility functions ---
        
        const getWorkoutById = (id) => customWorkouts.find(w => w.id === id);
        // The filter types are dynamically generated based on the new 18 workouts
        const getWorkoutTypes = () => ['All', ...new Set(customWorkouts.map(w => w.type))];
        const isSelected = (id) => selectedWorkoutsInModal.includes(id);


        // --- Main App Rendering and View Management ---
        
        const renderApp = () => {
            // Only the Schedule View remains
            renderChallengeGrid();
        };
        
        // --- Challenge Grid (Schedule View) Logic (Updated to use customWorkouts) ---
        
        const renderChallengeGrid = () => {
            const gridContainer = document.getElementById('challengeGrid');
            if (!gridContainer || customWorkouts.length === 0) {
                 gridContainer.innerHTML = '<p class="col-span-7 text-center text-gray-400">Loading workouts...</p>';
                 return;
            }


            gridContainer.innerHTML = ''; 


            for (let i = 0; i < DAYS_IN_CHALLENGE; i++) {
                const workoutIds = challengePlan[i];
                // Filter out Warm Up and Cool Down so they don't clutter the grid cells
                const mainWorkoutIds = workoutIds.filter(id => id !== WARM_UP_ID && id !== COOL_DOWN_ID);
                const workouts = mainWorkoutIds.map(id => getWorkoutById(id)).filter(w => w !== undefined);
                
                const week = Math.floor(i / 7) + 1;
                const day = (i % 7) + 1;


                // The cell now has a split click zone
                const cell = document.createElement('div');
                cell.className = 'challenge-cell rounded-lg p-3 bg-secondary-dark shadow-xl flex flex-col justify-between relative'; // Added relative

                
                // 2. Main Content Wrapper (Handles workout selection)
                const mainContentWrapper = document.createElement('div');
                mainContentWrapper.className = 'flex-grow cursor-pointer pt-2 text-center flex flex-col items-center justify-center';
                mainContentWrapper.title = `Click to edit workouts for Week ${week}, Day ${day}`;

                // Set click handler for main content to open modal
                mainContentWrapper.onclick = (e) => {
                    e.stopPropagation(); 
                    openWorkoutSelection(i);
                };

                let contentHtml = `<p class="font-bold text-light-text text-sm md:text-base">W${week} | Day ${day}</p>`;


                if (workouts.length > 0) {
                    // Check if only w18 (Rest) is scheduled for styling
                    const isRestDay = workouts.length === 1 && workouts[0].id === REST_WORKOUT_ID;

                    const workoutListHtml = workouts.map(w => `
                        <div class="text-xs leading-tight">
                            <span class="font-semibold ${isRestDay ? 'text-red-500' : 'text-accent-teal'}">${w.name}</span>
                        </div>
                    `).join('');


                    contentHtml += `<div class="my-2 space-y-1 text-sm">${workoutListHtml}</div>`;
                    
                } else {
                    contentHtml += `
                        <div class="flex-grow flex items-center justify-center text-center text-gray-400">
                            <p class="text-sm">Unplanned / Click to add</p>
                        </div>
                    `;
                }


                mainContentWrapper.innerHTML = contentHtml;
                cell.appendChild(mainContentWrapper);
                gridContainer.appendChild(cell);
            }
        };


        
        // --- Local Storage Management for Challenge Plan ---
        
        const savePlan = () => {
            localStorage.setItem(PLAN_STORAGE_KEY, JSON.stringify(challengePlan));
            localStorage.setItem(CHALLENGE_TITLE_KEY, challengeTitle); // Save title
            localStorage.setItem(DAILY_STATUS_KEY, JSON.stringify(dailyStatus)); // Save status
        };


        const loadPlan = () => {
            const savedPlan = localStorage.getItem(PLAN_STORAGE_KEY);
            if (savedPlan) {
                try {
                    const loadedPlan = JSON.parse(savedPlan);
                    if (Array.isArray(loadedPlan) && loadedPlan.length === DAYS_IN_CHALLENGE) {
                        challengePlan = loadedPlan.map(day => 
                            Array.isArray(day) 
                                ? day.filter(id => id !== WARM_UP_ID && id !== COOL_DOWN_ID) 
                                : []
                        );
                    }
                } catch (e) {
                    console.error("Error loading challenge plan from storage:", e);
                }
            }

            // Load new state variables
            const savedTitle = localStorage.getItem(CHALLENGE_TITLE_KEY);
            if (savedTitle) {
                challengeTitle = savedTitle;
            }

            const savedStatus = localStorage.getItem(DAILY_STATUS_KEY);
            if (savedStatus) {
                try {
                    const loadedStatus = JSON.parse(savedStatus);
                    if (Array.isArray(loadedStatus) && loadedStatus.length === DAYS_IN_CHALLENGE) {
                        dailyStatus = loadedStatus;
                    }
                } catch (e) { /* ignore */ }
            }

            // Ensure the title is displayed on load
            if(document.getElementById('mainChallengeTitle')) {
                 document.getElementById('mainChallengeTitle').textContent = challengeTitle;
            }
        };


        // --- New Daily Status Toggle Logic ---
        const toggleDayStatus = (index) => {
            const currentStatus = dailyStatus[index];
            const nextStatusMap = {
                'unplanned': 'completed',
                'completed': 'skipped',
                'skipped': 'unplanned',
            };
            dailyStatus[index] = nextStatusMap[currentStatus];
            savePlan();
            renderChallengeGrid(); 
        };
        
        // --- Challenge Day Selection Logic (WorkoutSelectionModal) ---
        
        const confirmSelection = () => {
            if (currentDayIndex !== null) {
                // Remove duplicates and save the final order
                challengePlan[currentDayIndex] = Array.from(new Set(selectedWorkoutsInModal));
                
                // If a workout is scheduled, set status to 'unplanned' (unless it was already completed/skipped)
                if (challengePlan[currentDayIndex].length > 0 && dailyStatus[currentDayIndex] === 'unplanned') {
                    dailyStatus[currentDayIndex] = 'unplanned'; 
                } else if (challengePlan[currentDayIndex].length === 0) {
                     dailyStatus[currentDayIndex] = 'unplanned';
                }

                renderChallengeGrid();
                savePlan();
                closeWorkoutSelection();
            }
        };
        
        const openWorkoutSelection = (index) => {
            currentDayIndex = index;
            // The selection modal only deals with the main workouts (excluding WU/CD)
            selectedWorkoutsInModal = challengePlan[index]; 
            expandedWorkoutId = null;
            
            const week = Math.floor(index / 7) + 1;
            const day = (index % 7) + 1;
            document.getElementById('modalTitle').textContent = `Edit Workouts for Week ${week}, Day ${day}`;
            
            initializeFilters();
            renderWorkoutList();


            document.getElementById('workoutSelectionModal').classList.remove('hidden');
        };


        const closeWorkoutSelection = () => {
            currentDayIndex = null;
            selectedWorkoutsInModal = []; 
            expandedWorkoutId = null; 
            document.getElementById('workoutSelectionModal').classList.add('hidden');
        };


        const toggleWorkoutSelection = (workoutId) => {
            const index = selectedWorkoutsInModal.indexOf(workoutId);
            
            const workout = getWorkoutById(workoutId);
            
            // Do not allow selection of Warm Up or Cool Down directly, they are not intended for daily scheduling
            if (workout?.type === 'WARM UP' || workout?.type === 'COOL DOWN') {
                return; 
            }

            // Handle REST special case (w18)
            if (workout?.type === 'REST') {
                // If rest is selected, remove all others. If deselected, remove only rest.
                if (index > -1) {
                    selectedWorkoutsInModal = [];
                } else {
                    selectedWorkoutsInModal = [workoutId];
                }
            } else {
                // If a real workout is selected, remove rest (w18) from the list if present
                selectedWorkoutsInModal = selectedWorkoutsInModal.filter(id => id !== REST_WORKOUT_ID);
                if (index > -1) {
                    selectedWorkoutsInModal.splice(index, 1);
                } else {
                    selectedWorkoutsInModal.push(workoutId);
                }
            }
            renderWorkoutList(); 
        }


        const toggleWorkoutDetails = (workoutId) => {
            expandedWorkoutId = expandedWorkoutId === workoutId ? null : workoutId;
            renderWorkoutList(); 
        }


        const renderWorkoutList = () => {
            const listContainer = document.getElementById('modalWorkoutList');
            if (!listContainer) return;


            const filteredWorkouts = selectedFilter === 'All'
                ? customWorkouts
                : customWorkouts.filter(w => w.type === selectedFilter);

            // Filter out Warm Up and Cool Down from the main selection list
            const selectableWorkouts = filteredWorkouts.filter(w => w.type !== 'WARM UP' && w.type !== 'COOL DOWN');


            listContainer.innerHTML = selectableWorkouts.map(w => {
                const selected = isSelected(w.id);
                const isExpanded = expandedWorkoutId === w.id;
                const bgColor = selected ? 'bg-accent-teal border-accent-teal' : 'bg-secondary-dark border-gray-700 hover:bg-gray-700';
                const textColor = selected ? 'text-primary-dark' : 'text-light-text';
                const iconColor = selected ? 'text-primary-dark' : 'text-accent-cyan';
                const isRest = w.type === 'REST';


                // Details Section HTML
                const detailsHtml = isExpanded ? `
                    <div class="mt-4 pt-4 border-t ${selected ? 'border-primary-dark/30' : 'border-gray-700'}">
                        <p class="font-semibold ${selected ? 'text-primary-dark/80' : 'text-gray-300'} mb-2">Description:</p>
                        <p class="text-sm ${selected ? 'text-primary-dark/90' : 'text-gray-400'} mb-3 whitespace-pre-wrap">${w.description}</p>
                        
                        <p class="font-semibold ${selected ? 'text-primary-dark/80' : 'text-gray-300'} mb-2">Structure:</p>
                        <p class="text-sm ${selected ? 'text-primary-dark/90' : 'text-gray-400'} mb-3 whitespace-pre-wrap">${w.structure}</p>
                        
                        <p class="font-semibold ${selected ? 'text-primary-dark/80' : 'text-gray-300'} mb-2">Tips:</p>
                        <p class="text-sm ${selected ? 'text-primary-dark/90' : 'text-gray-400'} whitespace-pre-wrap">${w.tips}</p>
                    </div>
                ` : '';


                return `
                    <div class="workout-card ${bgColor} p-4 rounded-xl shadow-xl border mb-4 relative">
                        <div onclick="toggleWorkoutSelection('${w.id}')" class="flex items-start cursor-pointer transition duration-100 hover:opacity-90">
                            <div class="mr-4 flex-shrink-0">
                                <img src="${w.thumbnailImage || DEFAULT_THUMBNAIL_URL}" alt="${w.name} image" onerror="this.onerror=null; this.src='${DEFAULT_THUMBNAIL_URL}'" class="w-20 h-20 rounded-lg object-cover shadow-md border ${selected ? 'border-primary-dark' : 'border-gray-600'}">
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-xl ${textColor}">${w.name}</p>
                                        <div class="mt-1 text-xs space-x-2 flex items-center">
                                            <span class="bg-gray-700 ${selected ? 'text-primary-dark bg-gray-200' : 'text-light-text'} px-2 py-0.5 rounded-full font-bold">${w.type}</span>
                                            <span class="font-medium ${selected ? 'text-primary-dark/80' : 'text-gray-300'}">${w.difficulty} | ${w.duration}</span>
                                        </div>
                                    </div>
                                    <div class="p-2 ${iconColor} flex-shrink-0">
                                        <i class="${selected ? 'fas fa-check-circle' : 'fas fa-circle-plus'} text-2xl"></i>
                                    </div>
                                </div>
                                <p class="text-sm mt-3 ${selected ? 'text-primary-dark/90' : 'text-gray-400'} italic">
                                    ${w.description.substring(0, 80).replace(/\n/g, ' ')}...
                                </p>
                            </div>
                        </div>
                        <div id="details-${w.id}" class="${isExpanded ? 'max-h-expand' : 'max-h-collapse'} overflow-hidden">
                            ${detailsHtml}
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="toggleWorkoutDetails('${w.id}')" class="text-sm font-semibold py-1 px-3 rounded-full transition duration-150 
                                ${selected ? 'bg-primary-dark/10 text-primary-dark hover:bg-primary-dark/30' : 'bg-gray-700 text-accent-cyan hover:bg-gray-600'}">
                                <i class="fas ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'} mr-1"></i> 
                                ${isExpanded ? 'Show Less Details' : 'Expand Full Workout'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };


        const initializeFilters = () => {
            const filterContainer = document.getElementById('modalFilterContainer');
            // Filter out Warm Up and Cool Down from the main filter bar
            const types = getWorkoutTypes().filter(type => type !== 'WARM UP' && type !== 'COOL DOWN');


            filterContainer.innerHTML = types.map(type => `
                <button
                    onclick="setFilter('${type}')"
                    class="filter-btn text-sm px-4 py-2 rounded-full font-bold transition duration-150 ${selectedFilter === type ? 'bg-accent-cyan text-primary-dark shadow-xl' : 'bg-gray-700 text-light-text hover:bg-gray-600'}"
                >
                    ${type}
                </button>
            `).join('');
        };


        const setFilter = (type) => {
            selectedFilter = type;
            expandedWorkoutId = null; 
            initializeFilters(); 
            renderWorkoutList();
        };


        // --- Other Utility Functions (clearPlan, executeAutoFill, generateChallengeDocument) ---
        
        /** Clears the entire challenge plan. */
        const clearPlan = () => {
            const confirmationModal = document.getElementById('confirmationModal');
            document.getElementById('confirmAction').onclick = () => {
                challengePlan = Array.from({ length: DAYS_IN_CHALLENGE }, () => []);
                dailyStatus = Array.from({ length: DAYS_IN_CHALLENGE }, () => 'unplanned');
                localStorage.removeItem(PLAN_STORAGE_KEY);
                localStorage.removeItem(DAILY_STATUS_KEY);
                renderChallengeGrid();
                confirmationModal.classList.add('hidden');
            };
            document.getElementById('cancelAction').onclick = () => {
                confirmationModal.classList.add('hidden');
            };
            document.getElementById('modalMessage').textContent = 'Are you sure you want to clear the entire 4-week challenge plan and all progress tracking?';
            document.getElementById('confirmAction').classList.remove('hidden'); 
            document.getElementById('cancelAction').textContent = 'Cancel'; 
            confirmationModal.classList.remove('hidden'); // Show it now
        };

        
        /** Executes the auto-fill based on the goal using the user-provided schedules. */
        const executeAutoFill = () => {
            const goal = document.querySelector('input[name="goal"]:checked')?.value;
            const difficulty = document.querySelector('input[name="difficulty"]:checked')?.value;
            
            if (!goal || !difficulty) {
                console.error("Goal or Difficulty not selected.");
                return;
            }
            
            // --- Workout ID Mappings based on full 18 Workouts ---
            const REST_ID = REST_WORKOUT_ID; 
            
            
            // Helper function to dynamically map workout types to the correct difficulty ID
            const getWorkoutId = (type, diff) => {
                // Map difficulty labels to the corresponding range in the ID list (w1-w5 B, w6-w10 I, w11-w15 A)
                let idRangeStart;
                if (diff === 'Beginner') idRangeStart = 1;
                else if (diff === 'Intermediate') idRangeStart = 6;
                else if (diff === 'Advanced') idRangeStart = 11;
                else return null; 

                const baseMap = {
                    'HIWT': 0,
                    'HIIT': 1,
                    'CORE': 2,
                    'ABS': 3,
                    'MUSCLE BUILDING': 4,
                };

                const offset = baseMap[type];
                if (offset !== undefined) {
                    return `w${idRangeStart + offset}`;
                }
                return null;
            }

            
            // Map specific IDs for the selected difficulty
            const hiwtWorkout = getWorkoutId('HIWT', difficulty);
            const hiitWorkout = getWorkoutId('HIIT', difficulty);
            const coreWorkout = getWorkoutId('CORE', difficulty);
            const absWorkout = getWorkoutId('ABS', difficulty);
            const muscleBuilding = getWorkoutId('MUSCLE BUILDING', difficulty);


            for (let i = 0; i < DAYS_IN_CHALLENGE; i++) {
                const dayOfWeek = i % 7; // 0=Mon, 1=Tue, ..., 6=Sun
                
                let workoutsForDay = [];

                switch (goal) {
                    case 'Weight Loss':
                        // Schedule: HIIT + CORE, HIWT, HIIT + ABS, HIWT, HIIT + CORE, MUSCLE, REST
                        switch (dayOfWeek) {
                            case 0: // Mon: HIIT + CORE
                                workoutsForDay = [hiitWorkout, coreWorkout];
                                break;
                            case 1: // Tue: HIWT
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 2: // Wed: HIIT + ABS
                                workoutsForDay = [hiitWorkout, absWorkout];
                                break;
                            case 3: // Thu: HIWT
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 4: // Fri: HIIT + CORE
                                workoutsForDay = [hiitWorkout, coreWorkout];
                                break;
                            case 5: // Sat: MUSCLE
                                workoutsForDay = [muscleBuilding];
                                break;
                            case 6: // Sun: REST
                                workoutsForDay = [REST_ID];
                                break;
                        }
                        break;

                    case 'Muscle Building':
                        // Schedule: MUSCLE, HIIT + ABS, MUSCLE, HIIT + CORE, MUSCLE, HIIT + ABS, REST
                        switch (dayOfWeek) {
                            case 0: // Mon: MUSCLE
                                workoutsForDay = [muscleBuilding]; 
                                break;
                            case 1: // Tue: HIIT + ABS
                                workoutsForDay = [hiitWorkout, absWorkout];
                                break;
                            case 2: // Wed: MUSCLE
                                workoutsForDay = [muscleBuilding]; 
                                break;
                            case 3: // Thu: HIIT + CORE
                                workoutsForDay = [hiitWorkout, coreWorkout];
                                break;
                            case 4: // Fri: MUSCLE
                                workoutsForDay = [muscleBuilding];
                                break;
                            case 5: // Sat: HIIT + ABS
                                workoutsForDay = [hiitWorkout, absWorkout];
                                break;
                            case 6: // Sun: REST
                                workoutsForDay = [REST_ID];
                                break;
                        }
                        break;
                        
                    case 'Maintenance':
                        // Schedule: HIWT + ABS, REST, HIIT + CORE, REST, MUSCLE, REST, REST
                        switch (dayOfWeek) {
                            case 0: // Mon: HIWT + ABS
                                workoutsForDay = [hiwtWorkout, absWorkout];
                                break;
                            case 1: // Tue: REST (Active/Recovery)
                                workoutsForDay = [REST_ID];
                                break;
                            case 2: // Wed: HIIT + CORE
                                workoutsForDay = [hiitWorkout, coreWorkout];
                                break;
                            case 3: // Thu: REST (Active/Recovery)
                                workoutsForDay = [REST_ID];
                                break;
                            case 4: // Fri: MUSCLE
                                workoutsForDay = [muscleBuilding];
                                break;
                            case 5: // Sat: REST (Active/Recovery)
                                workoutsForDay = [REST_ID];
                                break;
                            case 6: // Sun: REST
                                workoutsForDay = [REST_ID];
                                break;
                        }
                        break;

                    default:
                        // Fallback: clear the day
                        workoutsForDay = [];
                        break;
                }

                // Simply save the workout IDs, removing nulls/undefineds and ensuring REST only if present.
                let finalWorkouts = workoutsForDay.filter(id => id && getWorkoutById(id));
                if (finalWorkouts.includes(REST_ID)) {
                    finalWorkouts = [REST_ID];
                }

                // Filter out any potential duplicates
                challengePlan[i] = Array.from(new Set(finalWorkouts));
                
                // Reset status for newly generated plan
                dailyStatus[i] = 'unplanned'; 
            }
            
            renderChallengeGrid();
            savePlan();
            closeAutoFillOptions();
        };

        /** Helper function to convert newline-separated text into an HTML list for the document. 
         * Preserves existing <ul> or <ol> tags if they are present.
         */
        const formatTextAsList = (text) => {
            if (!text || typeof text !== 'string') return '';
            
            // If the content already contains HTML list structure, return it as is
            if (text.includes('<ul>') || text.includes('<ol>') || text.includes('<li>')) {
                return text; 
            }
            
            // Split the text by newline, filter out empty lines, and map to <li>
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) return '';
            
            // Wrap each line in a list item and the whole thing in an unordered list
            return `<ul style="margin-top: 5px; padding-left: 20px; list-style-type: disc;">${lines.map(line => `<li style="margin-bottom: 5px; color: #4b5563; font-size: 0.95rem;">${line.trim()}</li>`).join('')}</ul>`;
        };


        const generateChallengeDocument = () => {
            let docContent = ``;
            const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            // 1. Data Gathering for Document
            const scheduledWorkoutIds = new Set();
            challengePlan.flat().forEach(id => {
                if (id) scheduledWorkoutIds.add(id);
            });
            
            // Manually add Warm Up (w16) and Cool Down (w17) to the list of unique workouts
            scheduledWorkoutIds.add(WARM_UP_ID); 
            scheduledWorkoutIds.add(COOL_DOWN_ID); 


            // Convert set of IDs to workout objects
            let allScheduledWorkouts = Array.from(scheduledWorkoutIds).map(id => getWorkoutById(id)).filter(w => w !== undefined);
            
            // Sort: Primary Workouts (w1-w15) -> Rest (w18) -> Warm Up (w16) -> Cool Down (w17)
            const finalOrder = allScheduledWorkouts.sort((a, b) => {
                const orderMap = { [REST_WORKOUT_ID]: 99, [WARM_UP_ID]: 100, [COOL_DOWN_ID]: 101 }; 
                const aOrder = orderMap[a.id] || 0; 
                const bOrder = orderMap[b.id] || 0; 
                
                // Fallback for regular workouts: sort by ID numerically
                if (aOrder === 0 && bOrder === 0) {
                    return parseInt(a.id.substring(1)) - parseInt(b.id.substring(1));
                }
                
                return aOrder - bOrder;
            });
            
            // Calculate Progress Summary
            const completedCount = dailyStatus.filter(s => s === 'completed').length;
            const skippedCount = dailyStatus.filter(s => s === 'skipped').length;
            const plannedDays = challengePlan.filter(day => day.length > 0).length; // Days with at least one workout/rest scheduled
            const totalScheduledDays = 28;
            const completionRate = plannedDays > 0 ? ((completedCount / plannedDays) * 100).toFixed(1) : 0;





            // 2. Section 1: Schedule Grid 
            let scheduleHtml = `<h2 style="color: #1f2937; margin-top: 1.5rem; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem;">1. ${challengeTitle} Schedule</h2>`;
            scheduleHtml += `<p style="color: #4b5563; font-size: 1rem; margin-bottom: 20px;">This is the high-level view of your 28-day challenge plan, showing the scheduled core workouts for each day. Remember to perform a Warm Up before and a Cool Down after every non-Rest workout.</p>`;
            scheduleHtml += `<table style="width: 100%; border-collapse: collapse; margin-top: 15px; text-align: left; font-size: 0.9rem;">`;
            scheduleHtml += `<thead><tr>`;
            
            daysOfWeek.forEach(day => {
                scheduleHtml += `<th style="background-color: #f3f4f6; padding: 10px; border: 1px solid #d1d5db; color: #1f2937; text-align: center;">${day}</th>`;
            });
            scheduleHtml += `</tr></thead><tbody>`;


            for (let week = 0; week < 4; week++) {
                scheduleHtml += `<tr>`;
                for (let day = 0; day < 7; day++) {
                    const index = week * 7 + day;
                    const workoutIds = challengePlan[index];
                    const mainWorkoutIds = workoutIds.filter(id => id !== WARM_UP_ID && id !== COOL_DOWN_ID);

                    const workouts = mainWorkoutIds.map(id => getWorkoutById(id)).filter(w => w !== undefined);
                    
                    let cellContent = '';
                    if (workouts.length > 0) {
                        cellContent = workouts.map(w => `<span style="font-weight: bold; color: ${w.type === 'REST' ? '#dc2626' : '#14b8a6'};">${w.name}</span>`).join('<hr style="margin: 4px 0; border-top: 1px dashed #e5e7eb;">');
                    } else {
                        cellContent = '<span style="color: #9ca3af; font-style: italic;">Unplanned</span>';
                    }
                    
                    scheduleHtml += `<td style="padding: 10px; border: 1px solid #d1d5db; vertical-align: top; background-color: ${day % 2 === 0 ? '#f9fafb' : '#ffffff'};">
                        <span style="font-weight: bold; color: #374151; font-size: 0.85rem;">W${week + 1} | Day ${day + 1}</span>
                        <div style="margin-top: 5px;">${cellContent}</div>
                    </td>`;
                }
                scheduleHtml += `</tr>`;
            }


            scheduleHtml += `</tbody></table>`;
            docContent += scheduleHtml;
            docContent += `<hr style="margin: 2.5rem 0; border: none; border-top: 3px double #e5e7eb;">`;


            // 3. Section 2: Detailed Workouts 
            let workoutDetailsHtml = `<h2 style="color: #1f2937; margin-top: 1.5rem; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem;">2. Detailed Workout Descriptions</h2>`;
            workoutDetailsHtml += `<p style="color: #4b5563; font-size: 1rem; margin-bottom: 20px;">Below are the complete details for every unique workout in your plan, including the essential Warm Up and Cool Down routines for safe and effective training.</p>`;


            finalOrder.forEach((w) => { // ITERATING OVER ORDERED LIST
                // Use the single documentImage field
                const largeImageSrc = w.documentImage || DEFAULT_LARGE_IMAGE_URL;


                workoutDetailsHtml += `
                    <div style="border: 1px solid #d1d5db; border-radius: 12px; padding: 20px; margin-bottom: 25px; background-color: #f9fafb; box-shadow: 0 4px 6px rgba(0,0,0,0.05); page-break-inside: avoid;">
                        
                        <!-- Instructional/Reference Image -->
                        <div style="width: 100%; margin-bottom: 20px; text-align: center;">
                            <p style="font-weight: bold; margin-bottom: 5px; color: #374151; font-size: 0.9rem;">Instructional/Reference Image</p>
                            <img src="${largeImageSrc}" alt="${w.name} guide"
     onerror="this.onerror=null; this.src='${DEFAULT_LARGE_IMAGE_URL}'"
     style="width: 100%; height: auto; border-radius: 8px; border: 1px solid #a1a1aa; object-fit: cover; margin: 0 auto; display: block;">


                        </div>


                        <h3 style="margin-top: 0; margin-bottom: 5px; color: #1f2937; font-size: 1.4rem; font-weight: bold;">${w.name}</h3>
                        <p style="margin-top: 0; color: #6b7280; font-size: 0.9rem; line-height: 1.4;">
                            <strong style="color: #14b8a6;">Type:</strong> ${w.type} | 
                            <strong style="color: #14b8a6;">Duration:</strong> ${w.duration} | 
                            <strong style="color: #14b8a6;">Difficulty:</strong> ${w.difficulty}
                        </p>
                        
                        <h4 style="margin-top: 15px; color: #374151; font-size: 1.1rem; font-weight: bold;">Description:</h4>
                        ${formatTextAsList(w.description)}


                        <h4 style="margin-top: 15px; color: #374151; font-size: 1.1rem; font-weight: bold;">Structure:</h4>
                        ${formatTextAsList(w.structure)}


                        <h4 style="margin-top: 15px; color: #374151; font-size: 1.1rem; font-weight: bold;">Tips:</h4>
                        ${formatTextAsList(w.tips)}


                    </div>
                `;
            });


            docContent += workoutDetailsHtml;
            docContent += `<hr style="margin: 2.5rem 0; border: none; border-top: 3px double #e5e7eb;">`;
            
            // 4. NEW: Section 3: Tracking Sheet
            let trackingSheetHtml = `<h2 style="color: #1f2937; margin-top: 1.5rem; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem;">3. Weekly Progress Tracking Sheet (Printable)</h2>`;
            trackingSheetHtml += `<p style="color: #4b5563; font-size: 1rem; margin-bottom: 20px;">Use this sheet to track workout completion, rate your effort, and make notes on how the session went (e.g., increased weight, difficulty, energy levels).</p>`;

            for (let week = 0; week < 4; week++) {
                trackingSheetHtml += `<h3 style="margin-top: 25px; color: #14b8a6; font-size: 1.2rem; font-weight: bold; border-bottom: 1px dashed #d1d5db; padding-bottom: 5px;">WEEK ${week + 1} TRACKING</h3>`;
                trackingSheetHtml += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px; text-align: left; font-size: 0.85rem; page-break-inside: auto;">`;
                
                // Table Headers
                trackingSheetHtml += `<thead><tr>`;
                trackingSheetHtml += `<th style="background-color: #f3f4f6; padding: 8px; border: 1px solid #d1d5db; color: #1f2937; width: 15%; min-width: 80px;">Day</th>`;
                trackingSheetHtml += `<th style="background-color: #f3f4f6; padding: 8px; border: 1px solid #d1d5db; color: #1f2937; width: 25%;">Scheduled Workout(s)</th>`;
                trackingSheetHtml += `<th style="background-color: #f3f4f6; padding: 8px; border: 1px solid #d1d5db; color: #1f2937; width: 15%; text-align: center;">Completed (Y/N)</th>`;
                trackingSheetHtml += `<th style="background-color: #f3f4f6; padding: 8px; border: 1px solid #d1d5db; color: #1f2937; width: 15%; text-align: center;">Effort (1-5)</th>`;
                trackingSheetHtml += `<th style="background-color: #f3f4f6; padding: 8px; border: 1px solid #d1d5db; color: #1f2937; width: 30%;">Notes & Progress</th>`;
                trackingSheetHtml += `</tr></thead><tbody>`;

                for (let day = 0; day < 7; day++) {
                    const index = week * 7 + day;
                    const dayNumber = index + 1;
                    
                    const workoutIds = challengePlan[index];
                    const mainWorkoutIds = workoutIds.filter(id => id !== WARM_UP_ID && id !== COOL_DOWN_ID);
                    const workouts = mainWorkoutIds.map(id => getWorkoutById(id)).filter(w => w !== undefined);
                    
                    let scheduledWorkouts = '';
                    if (workouts.length > 0) {
                         scheduledWorkouts = workouts.map(w => `<span style="color: ${w.type === 'REST' ? '#dc2626' : '#1f2937'};">${w.name}</span>`).join('<br>');
                    } else {
                        scheduledWorkouts = '<span style="color: #9ca3af; font-style: italic;">Unplanned</span>';
                    }

                    trackingSheetHtml += `<tr>`;
                    trackingSheetHtml += `<td style="padding: 8px; border: 1px solid #d1d5db; background-color: ${day % 2 === 0 ? '#fafafa' : '#ffffff'};">Day ${dayNumber} (${daysOfWeek[day]})</td>`;
                    trackingSheetHtml += `<td style="padding: 8px; border: 1px solid #d1d5db; background-color: ${day % 2 === 0 ? '#fafafa' : '#ffffff'};">${scheduledWorkouts}</td>`;
                    trackingSheetHtml += `<td style="padding: 8px; border: 1px solid #d1d5db; background-color: ${day % 2 === 0 ? '#fafafa' : '#ffffff'}; text-align: center;"></td>`;
                    trackingSheetHtml += `<td style="padding: 8px; border: 1px solid #d1d5db; background-color: ${day % 2 === 0 ? '#fafafa' : '#ffffff'}; text-align: center;"></td>`;
                    trackingSheetHtml += `<td style="padding: 8px; border: 1px solid #d1d5db; background-color: ${day % 2 === 0 ? '#fafafa' : '#ffffff'}; height: 30px;"></td>`; // Empty space for notes
                    trackingSheetHtml += `</tr>`;
                }

                trackingSheetHtml += `</tbody></table>`;
            }

            docContent += trackingSheetHtml;


            // 5. Final Output to Print Window
            const w = window.open();
            w.document.write(`
                <html class="p-8 font-sans">
                    <head>
                        <title>${challengeTitle} Document</title>
                        <style>
                            /* Styles for the print view */
                            body {
  width: 100%;
  max-width: none;
  margin: 0;
  padding: 30px;
  line-height: 1.6;
  font-family: 'Inter', sans-serif;
}

@page {
  size: A4;
  margin: 20mm;
}

@media print {
  html, body {
    width: 100%;
    height: auto;
    margin: 0;
    padding: 0;
  }
  body > * {
    page-break-inside: avoid;
  }
  img {
    max-width: 100% !important;
    height: auto !important;
  }
}


                            h1 { font-size: 2.5rem; color: #14b8a6; text-align: center; margin-bottom: 10px;} 
                            h2 { font-size: 1.5rem; color: #1f2937; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem; }
                            h3 { font-size: 1.4rem; color: #374151; margin-top: 0; }
                            h4 { font-size: 1.1rem; color: #4b5563; font-weight: bold; }
                            p, ul, ol, li, table { font-size: 1rem; color: #4b5563; }

                            /* Updated list styling for bullet points */
                            ul, ol { 
                                margin: 10px 0 10px 0; 
                                padding-left: 20px;
                            }
                            li {
                                margin-bottom: 8px; /* Added spacing between list items */
                            }
                            
                            .print-button { 
                                margin-top: 2rem; padding: 0.75rem 1.5rem; 
                                background-color: #14b8a6; color: white; 
                                font-weight: bold; border-radius: 0.5rem; cursor: pointer; border: none; 
                                display: block; width: 250px; margin-left: auto; margin-right: auto; text-align: center;
                                text-decoration: none;
                            }
                            @media print { .print-button { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1>🏋️ ${challengeTitle} Plan</h1>
                        <p style="text-align: center; color: #6b7280; margin-bottom: 30px;">Your complete 28-day fitness schedule, designed for easy tracking and reference.</p>
                        <a href="#" class="print-button" onclick="window.print(); return false;">Print Challenge Document</a>
                        ${docContent}
                        <a href="#" class="print-button" onclick="window.print(); return false;">Print Challenge Document</a>
                    </body>
                </html>
            `);
            w.document.close();
        };


        const openAutoFillOptions = () => {
            document.getElementById('autoFillOptionsModal').classList.remove('hidden');
            // Ensure one option is checked by default if none are
            if (!document.querySelector('input[name="goal"]:checked')) {
                document.querySelector('input[name="goal"][value="Weight Loss"]').checked = true;
            }
            if (!document.querySelector('input[name="difficulty"]:checked')) {
                document.querySelector('input[name="difficulty"][value="Intermediate"]').checked = true;
            }
        };


        const closeAutoFillOptions = () => {
            document.getElementById('autoFillOptionsModal').classList.add('hidden');
        };
        
        // --- Title Editing Functions ---
        const startEditTitle = () => {
            const titleH1 = document.getElementById('mainChallengeTitle');
            const oldTitle = challengeTitle;

            // Replace H1 with an input field
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldTitle;
            input.className = 'text-4xl font-extrabold text-primary-dark text-center bg-light-text rounded-lg px-2 py-1 w-full max-w-xl mx-auto focus:outline-none focus:ring-4 ring-accent-cyan';
            input.id = 'editInput';
            
            // Replace the H1 with the input
            titleH1.parentNode.insertBefore(input, titleH1);
            titleH1.classList.add('hidden');
            document.getElementById('editTitleBtn').classList.add('hidden');
            
            input.focus();
            input.setSelectionRange(0, input.value.length);

            const finishEdit = () => {
                let newTitle = input.value.trim();
                if (newTitle === '') {
                    newTitle = oldTitle; // Revert if empty
                }

                challengeTitle = newTitle;
                titleH1.textContent = newTitle;

                // Restore H1 and button, remove input
                titleH1.classList.remove('hidden');
                document.getElementById('editTitleBtn').classList.remove('hidden');
                input.remove();

                savePlan();
            };

            input.addEventListener('blur', finishEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    finishEdit();
                    e.preventDefault();
                }
            });
        };


        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPlan(); 
            renderApp(); 


            // Global buttons
            document.getElementById('autoFillBtn').addEventListener('click', openAutoFillOptions); 
            document.getElementById('clearPlanBtn').addEventListener('click', clearPlan);
            document.getElementById('generatePrintBtn').addEventListener('click', generateChallengeDocument);


            // Listeners for Modals
            document.getElementById('workoutSelectionModal').addEventListener('click', (e) => {
                if (e.target.id === 'workoutSelectionModal' || e.target.closest('#modalCloseBtn')) {
                    closeWorkoutSelection();
                }
            });
            document.getElementById('confirmSelectionBtn').addEventListener('click', confirmSelection);
            
            document.getElementById('autoFillOptionsModal').addEventListener('click', (e) => {
                 if (e.target.id === 'autoFillOptionsModal' || e.target.closest('#autoFillCloseBtn')) {
                    closeAutoFillOptions();
                }
            });
            document.getElementById('executeAutoFillBtn').addEventListener('click', executeAutoFill);
        });


        // Expose functions for inline onclick/script access
        window.clearPlan = clearPlan;
        window.setFilter = setFilter;
        window.toggleWorkoutSelection = toggleWorkoutSelection;
        window.toggleWorkoutDetails = toggleWorkoutDetails;
        window.closeWorkoutSelection = closeWorkoutSelection;
        window.executeAutoFill = executeAutoFill; 
        window.startEditTitle = startEditTitle; // Expose new function
        
        // Custom Modal for non-alert confirmation (for clearPlan)
        document.write(`
            <div id="confirmationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
                <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <p id="modalMessage" class="text-light-text text-lg mb-6"></p>
                    <div class="flex justify-end space-x-4">
                        <button id="cancelAction" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            Cancel
                        </button>
                        <button id="confirmAction" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
        `);
    </script>
    
    


<style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: #f3f4f6;
        }
        .challenge-cell {
            min-height: 120px;
            cursor: default; /* Change cursor to default since the status icon is the main click target on top right */
            transition: all 0.2s;
            border: 2px solid #374151;
            /* New: Focus state on hover comes from inner wrapper or the button */
        }
        .challenge-cell:hover {
            border-color: #374151; /* Keep border stable */
            box-shadow: none;
        }
        /* Style the actual clickable main content area */
        .challenge-cell > div:first-child:hover {
            opacity: 0.9;
            text-shadow: 0 0 5px rgba(243, 244, 246, 0.1);
        }
        .workout-card {
            transition: background-color 0.1s;
        }
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
        /* Custom classes for smooth height transitions */
        .max-h-expand {
            max-height: 1000px; /* Sufficiently large value */
            transition: max-height 0.4s ease-in-out;
        }
        .max-h-collapse {
            max-height: 0;
            transition: max-height 0.4s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-primary-dark">


    <div id="appContainer">
        
        


<header class="text-center mb-8">
            <!-- Renamed element ID and added click handler -->
            <div class="flex justify-center items-center">
                <h1 id="mainChallengeTitle" class="text-4xl font-extrabold text-accent-teal mb-2 cursor-pointer hover:text-accent-cyan transition duration-150" onclick="startEditTitle()">
                    4-Week Home Workout Challenge
                </h1>
                <button id="editTitleBtn" onclick="startEditTitle()" class="ml-3 mb-2 text-gray-400 hover:text-accent-teal transition duration-150">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <p class="text-lg text-gray-300">Your personalized, local fitness plan generator.</p>
        </header>


        


<div id="scheduleView" class="lg:w-full">
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="autoFillBtn" class="flex-1 min-w-[150px] bg-accent-teal hover:bg-teal-600 text-primary-dark font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    <i class="fas fa-magic mr-2"></i> Auto-Fill Challenge
                </button>
                <button id="clearPlanBtn" class="flex-1 min-w-[150px] bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    <i class="fas fa-trash mr-2"></i> Clear Plan
                </button>
                <button id="generatePrintBtn" class="flex-1 min-w-[150px] bg-accent-cyan hover:bg-cyan-600 text-primary-dark font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    <i class="fas fa-file-alt mr-2"></i> Create Challenge Document
                </button>
            </div>
    
            <div class="bg-secondary-dark p-4 md:p-6 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-bold text-light-text mb-4">Your 28-Day Schedule</h2>
                <!-- UPDATED GRID CLASSES FOR BETTER MOBILE RESPONSIVENESS -->
                <div id="challengeGrid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
                    <p class="col-span-7 text-center text-gray-400">Loading workouts...</p>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Workout Selection Modal (Used in Schedule View) -->
    <div id="workoutSelectionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-primary-dark p-6 rounded-xl shadow-2xl w-full max-w-4xl h-[90%] overflow-y-auto border border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3 sticky top-0 bg-primary-dark z-10">
                <h2 id="modalTitle" class="text-3xl font-extrabold text-accent-teal">Edit Workouts</h2>
                <button id="modalCloseBtn" class="text-gray-400 hover:text-red-500 transition duration-150">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>


            <div id="modalFilterContainer" class="flex flex-wrap gap-2 mb-6 sticky top-[80px] bg-primary-dark py-2 border-b border-gray-800 z-10">
                <!-- Filters will be rendered here -->
            </div>


            <div id="modalWorkoutList" class="custom-scroll flex-grow overflow-y-auto pr-4">
                <!-- Workout list will be rendered here -->
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-700 sticky bottom-0 bg-primary-dark z-10">
                <button id="confirmSelectionBtn" class="w-full bg-accent-cyan hover:bg-cyan-600 text-primary-dark font-extrabold py-3 rounded-xl shadow-lg transition duration-200">
                    <i class="fas fa-save mr-2"></i> Confirm Selection
                </button>
            </div>
        </div>
    </div>
    
    <!-- Auto-Fill Options Modal (Used in Schedule View) -->
    <div id="autoFillOptionsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700">
            
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                <h2 class="text-3xl font-extrabold text-accent-teal"><i class="fas fa-magic mr-2"></i> Auto-Fill Options</h2>
                <button id="autoFillCloseBtn" class="text-gray-400 hover:text-red-500 transition duration-150">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>


            <div class="mb-6">
                <h3 class="text-xl font-semibold text-light-text mb-3">1. Select Your Primary Goal</h3>
                <div class="flex flex-wrap gap-3">
                    <label class="flex-1">
                        <input type="radio" name="goal" value="Weight Loss" class="hidden peer" checked>
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-teal peer-checked:border-accent-teal peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Weight Loss
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="goal" value="Muscle Building" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-teal peer-checked:border-accent-teal peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Muscle Building
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="goal" value="Maintenance" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-teal peer-checked:border-accent-teal peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Maintenance
                        </div>
                    </label>
                </div>
            </div>


            <div class="mb-8">
                <h3 class="text-xl font-semibold text-light-text mb-3">2. Select Your Experience Level</h3>
                <div class="flex flex-wrap gap-3">
                    <label class="flex-1">
                        <input type="radio" name="difficulty" value="Beginner" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-cyan peer-checked:border-accent-cyan peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Beginner
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="difficulty" value="Intermediate" class="hidden peer" checked>
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-cyan peer-checked:border-accent-cyan peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Intermediate
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="difficulty" value="Advanced" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-cyan peer-checked:border-accent-cyan peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Advanced
                        </div>
                    </label>
                </div>
            </div>


            <button id="executeAutoFillBtn" class="w-full bg-accent-teal hover:bg-teal-600 text-primary-dark font-extrabold py-3 rounded-xl shadow-lg transition duration-200">
                Generate 4-Week Plan
            </button>
        </div>
    </div>
    
</body>
</html>