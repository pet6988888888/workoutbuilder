<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-Week Workout Challenge Builder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        // Define Tailwind Configuration with custom colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#111827',     // Darkest background
                        'secondary-dark': '#1f2937',   // Card/Cell background
                        'accent-teal': '#14b8a6',      // Teal for primary actions/highlights
                        'accent-cyan': '#06b6d4',      // Cyan for secondary highlights
                        'light-text': '#f3f4f6',       // Light text color
                    },
                }
            }
        }
    </script>


<script type="text/javascript">
        // Define storage keys and constants
        const PLAN_STORAGE_KEY = 'workoutChallengePlan';
        const DAYS_IN_CHALLENGE = 28;
        // UPDATED REST WORKOUT ID to match the new simplified list (w6)
        const REST_WORKOUT_ID = 'w6'; 
        const DEFAULT_THUMBNAIL_URL = 'https://placehold.co/80x80/6B7280/FFFFFF?text=W'; // Placeholder image for lists
        const DEFAULT_LARGE_IMAGE_URL = 'https://placehold.co/400x300/6B7280/FFFFFF?text=GUIDE+IMAGE'; // Placeholder for large images


        // Application State
        let challengePlan = Array.from({ length: DAYS_IN_CHALLENGE }, () => []); 
        let currentDayIndex = null; 
        let selectedFilter = 'All'; 
        let selectedWorkoutsInModal = []; 
        let expandedWorkoutId = null; 
        
        // --- START OF SIMPLIFIED WORKOUT DATA (6 ENTRIES) ---
        // CRITICAL FIX: The 'type' property now matches the required tag names exactly: HIWT, HIIT, CORE, ABS, MUSCLE BUILDING, REST.
        const DEFAULT_WORKOUTS = [
            // 1. HIWT (High Intensity Weight Training) - TYPE: HIWT
            { 
                id: 'w1', name: 'HIWT (High Intensity Weight Training)', type: 'HIWT', difficulty: 'Intermediate', duration: '40 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=HIWT', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=HIWT+GUIDE', 
                description: 'A 40-minute high-intensity workout using minimal equipment to build strength endurance. Uses short 20/10 intervals alternating between two compound movements.', 
                structure: '5 Combos of 4 rounds each (20s work / 10s rest). 60s rest between combos. Focus on full-body movements.', 
                tips: 'Keep intensity high during the work periods. Prioritize form over speed when lifting.', focus: 'Weight Loss, Strength Endurance' 
            },
            // 2. HIIT (High Intensity Interval Training) - TYPE: HIIT
            { 
                id: 'w2', name: 'HIIT Cardio Blast', type: 'HIIT', difficulty: 'Intermediate', duration: '30 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=HIIT', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=HIIT+GUIDE', 
                description: 'A pure, fast-paced cardio blast using bodyweight movements to maximize calorie burn and improve anaerobic fitness.', 
                structure: '6 rounds of 4 exercises (40s work / 20s rest). 60s rest between rounds. Maximize jumps and speed.', 
                tips: 'Go all-out during the work period. Short rest is for recovery, not cooling down.', focus: 'Weight Loss, Cardio' 
            },
            // 3. CORE (360 Static Hold Routine) - TYPE: CORE
            { 
                id: 'w3', name: 'CORE (360 Static Hold Routine)', type: 'CORE', difficulty: 'Beginner', duration: '15 min', 
                thumbnailImage: 'https://placehold.co/80x80/f3f4f6/111827?text=CORE', 
                documentImage: 'https://placehold.co/400x300/f3f4f6/111827?text=CORE+GUIDE', 
                description: 'A simple, static core routine targeting front, side, and back stabilizers (360 degrees). Ideal for beginners or as an add-on.', 
                structure: '3 static exercises (Plank, Side Plank L/R, Bridge). Hold each for 30s. Complete 3 rounds with 30s rest between rounds.', 
                tips: 'Maintain a straight line from head to heels. Engage your glutes and abs throughout the hold.', focus: 'Core Strength' 
            },
            // 4. ABS (Dynamic Abdominal Circuit) - TYPE: ABS
            { 
                id: 'w4', name: 'ABS (Dynamic Abdominal Circuit)', type: 'ABS', difficulty: 'Intermediate', duration: '20 min', 
                thumbnailImage: 'https://placehold.co/80x80/14b8a6/FFFFFF?text=ABS', 
                documentImage: 'https://placehold.co/400x300/14b8a6/FFFFFF?text=ABS+GUIDE', 
                description: 'A circuit of dynamic movements focusing on defining the upper and lower abdominals and obliques.', 
                structure: '4 dynamic exercises (Crunches, Leg Raises, Russian Twists, Flutter Kicks). 30s work / 10s rest. Complete 5 rounds. No rest between rounds.', 
                tips: 'Do not pull on your neck. Focus on squeezing your core muscles to initiate the movement.', focus: 'Core Definition' 
            },
            // 5. MUSCLE BUILDING (GVT 10x10) - TYPE: MUSCLE BUILDING
            { 
                id: 'w5', name: 'MUSCLE BUILDING (GVT 10x10)', type: 'MUSCLE BUILDING', difficulty: 'Advanced', duration: '60 min', 
                thumbnailImage: 'https://placehold.co/80x80/06b6d4/FFFFFF?text=MUSC', 
                documentImage: 'https://placehold.co/400x300/06b6d4/FFFFFF?text=MUSCLE+GUIDE', 
                description: 'German Volume Training protocol using high volume (10 sets of 10 reps) to promote significant muscular hypertrophy (growth). Requires dumbbells or resistance.', 
                structure: '2 main compound lifts (e.g., Squats, Bench Press). 10 sets of 10 reps per lift. Use a weight you can lift for 20 reps. 90s rest between sets.', 
                tips: 'The goal is muscle failure near the end of the 10 sets. Use slow, controlled negative (lowering) movements.', focus: 'Muscle Building, Hypertrophy' 
            },
            // 6. REST (Full Recovery) - TYPE: REST
            { 
                id: 'w6', name: 'Full Recovery', type: 'REST', difficulty: 'Beginner', duration: 'N/A', 
                thumbnailImage: 'https://placehold.co/80x80/6B7280/FFFFFF?text=REST', 
                documentImage: 'https://placehold.co/400x300/6B7280/FFFFFF?text=REST+DAY', 
                description: 'Full physical rest to allow muscles to repair and grow stronger. Crucial for recovery and injury prevention.', 
                structure: 'Focus on sleep, nutrition, and hydration. Optional: 15 minutes of light walking or foam rolling.', 
                tips: 'Avoid strenuous activity. Prioritize 7-9 hours of sleep. This is when the gains happen!', focus: 'All' 
            }
        ];
        
        // Workout data is loaded from the hardcoded list
        let customWorkouts = DEFAULT_WORKOUTS; 


        // --- Utility functions ---
        
        const getWorkoutById = (id) => customWorkouts.find(w => w.id === id);
        // The filter types are dynamically generated based on the new 6 workouts (HIWT, HIIT, CORE, ABS, MUSCLE BUILDING, REST)
        const getWorkoutTypes = () => ['All', ...new Set(customWorkouts.map(w => w.type))];
        const isSelected = (id) => selectedWorkoutsInModal.includes(id);


        // --- Main App Rendering and View Management ---
        
        const renderApp = () => {
            // Only the Schedule View remains
            renderChallengeGrid();
        };
        
        // --- Challenge Grid (Schedule View) Logic (Updated to use customWorkouts) ---
        
        const renderChallengeGrid = () => {
            const gridContainer = document.getElementById('challengeGrid');
            if (!gridContainer || customWorkouts.length === 0) {
                 gridContainer.innerHTML = '<p class="col-span-7 text-center text-gray-400">Loading workouts...</p>';
                 return;
            }


            gridContainer.innerHTML = ''; 


            for (let i = 0; i < DAYS_IN_CHALLENGE; i++) {
                const workoutIds = challengePlan[i];
                const workouts = workoutIds.map(id => getWorkoutById(id)).filter(w => w !== undefined);
                const week = Math.floor(i / 7) + 1;
                const day = (i % 7) + 1;


                const cell = document.createElement('div');
                cell.className = 'challenge-cell rounded-lg p-3 bg-secondary-dark shadow-xl flex flex-col justify-between';
                cell.setAttribute('data-index', i);


                cell.onclick = () => openWorkoutSelection(i);
                cell.title = `Click to edit workouts for Week ${week}, Day ${day}`;
                
                let contentHtml = `<p class="font-bold text-light-text text-sm md:text-base">W${week} | Day ${day}</p>`;


                if (workouts.length > 0) {
                    // Check if only w6 (Rest) is scheduled for styling
                    const isRestDay = workouts.length === 1 && workouts[0].id === REST_WORKOUT_ID;

                    const workoutListHtml = workouts.map(w => `
                        <div class="text-xs leading-tight">
                            <span class="font-semibold ${isRestDay ? 'text-red-500' : 'text-accent-teal'}">${w.name}</span>
                            <span class="text-gray-400">(${w.type})</span>
                        </div>
                    `).join('');


                    contentHtml += `<div class="my-2 space-y-1 text-sm">${workoutListHtml}</div>`;
                    
                } else {
                    contentHtml += `
                        <div class="flex-grow flex items-center justify-center text-center text-gray-400">
                            <p class="text-sm">Unplanned / Click to add</p>
                        </div>
                    `;
                }


                cell.innerHTML = contentHtml;
                gridContainer.appendChild(cell);
            }
        };


        
        // --- Local Storage Management for Challenge Plan ---
        
        const savePlan = () => {
            localStorage.setItem(PLAN_STORAGE_KEY, JSON.stringify(challengePlan));
        };


        const loadPlan = () => {
            const savedPlan = localStorage.getItem(PLAN_STORAGE_KEY);
            if (savedPlan) {
                try {
                    const loadedPlan = JSON.parse(savedPlan);
                    if (Array.isArray(loadedPlan) && loadedPlan.length === DAYS_IN_CHALLENGE) {
                        challengePlan = loadedPlan.map(day => Array.isArray(day) ? day : []);
                    }
                } catch (e) {
                    console.error("Error loading challenge plan from storage:", e);
                }
            }
        };


        // --- Challenge Day Selection Logic (WorkoutSelectionModal) ---
        
        const confirmSelection = () => {
            if (currentDayIndex !== null) {
                challengePlan[currentDayIndex] = selectedWorkoutsInModal;
                renderChallengeGrid();
                savePlan();
                closeWorkoutSelection();
            }
        };
        
        const openWorkoutSelection = (index) => {
            currentDayIndex = index;
            selectedWorkoutsInModal = [...challengePlan[index]]; 
            expandedWorkoutId = null;
            
            const week = Math.floor(index / 7) + 1;
            const day = (index % 7) + 1;
            document.getElementById('modalTitle').textContent = `Edit Workouts for Week ${week}, Day ${day}`;
            
            initializeFilters();
            renderWorkoutList();


            document.getElementById('workoutSelectionModal').classList.remove('hidden');
        };


        const closeWorkoutSelection = () => {
            currentDayIndex = null;
            selectedWorkoutsInModal = []; 
            expandedWorkoutId = null; 
            document.getElementById('workoutSelectionModal').classList.add('hidden');
        };


        const toggleWorkoutSelection = (workoutId) => {
            const index = selectedWorkoutsInModal.indexOf(workoutId);
            
            const workout = getWorkoutById(workoutId);


            // Handle REST special case
            if (workout?.type === 'REST') {
                // If rest is selected, remove all others. If deselected, remove only rest.
                if (index > -1) {
                    selectedWorkoutsInModal = [];
                } else {
                    selectedWorkoutsInModal = [workoutId];
                }
            } else {
                // If a real workout is selected, remove rest from the list if present
                selectedWorkoutsInModal = selectedWorkoutsInModal.filter(id => getWorkoutById(id)?.type !== 'REST');
                if (index > -1) {
                    selectedWorkoutsInModal.splice(index, 1);
                } else {
                    selectedWorkoutsInModal.push(workoutId);
                }
            }
            renderWorkoutList(); 
        }


        const toggleWorkoutDetails = (workoutId) => {
            expandedWorkoutId = expandedWorkoutId === workoutId ? null : workoutId;
            renderWorkoutList(); 
        }


        const renderWorkoutList = () => {
            const listContainer = document.getElementById('modalWorkoutList');
            if (!listContainer) return;


            const filteredWorkouts = selectedFilter === 'All'
                ? customWorkouts
                : customWorkouts.filter(w => w.type === selectedFilter);


            listContainer.innerHTML = filteredWorkouts.map(w => {
                const selected = isSelected(w.id);
                const isExpanded = expandedWorkoutId === w.id;
                const bgColor = selected ? 'bg-accent-teal border-accent-teal' : 'bg-secondary-dark border-gray-700 hover:bg-gray-700';
                const textColor = selected ? 'text-primary-dark' : 'text-light-text';
                const iconColor = selected ? 'text-primary-dark' : 'text-accent-cyan';


                // Details Section HTML
                const detailsHtml = isExpanded ? `
                    <div class="mt-4 pt-4 border-t ${selected ? 'border-primary-dark/30' : 'border-gray-700'}">
                        <p class="font-semibold ${selected ? 'text-primary-dark/80' : 'text-gray-300'} mb-2">Description:</p>
                        <p class="text-sm ${selected ? 'text-primary-dark/90' : 'text-gray-400'} mb-3 whitespace-pre-wrap">${w.description}</p>
                        
                        <p class="font-semibold ${selected ? 'text-primary-dark/80' : 'text-gray-300'} mb-2">Structure:</p>
                        <p class="text-sm ${selected ? 'text-primary-dark/90' : 'text-gray-400'} mb-3 whitespace-pre-wrap">${w.structure}</p>
                        
                        <p class="font-semibold ${selected ? 'text-primary-dark/80' : 'text-gray-300'} mb-2">Tips:</p>
                        <p class="text-sm ${selected ? 'text-primary-dark/90' : 'text-gray-400'} whitespace-pre-wrap">${w.tips}</p>
                    </div>
                ` : '';


                return `
                    <div class="workout-card ${bgColor} p-4 rounded-xl shadow-xl border mb-4 relative">
                        <div onclick="toggleWorkoutSelection('${w.id}')" class="flex items-start cursor-pointer transition duration-100 hover:opacity-90">
                            <div class="mr-4 flex-shrink-0">
                                <img src="${w.thumbnailImage || DEFAULT_THUMBNAIL_URL}" alt="${w.name} image" onerror="this.onerror=null; this.src='${DEFAULT_THUMBNAIL_URL}'" class="w-20 h-20 rounded-lg object-cover shadow-md border ${selected ? 'border-primary-dark' : 'border-gray-600'}">
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-xl ${textColor}">${w.name}</p>
                                        <div class="mt-1 text-xs space-x-2 flex items-center">
                                            <span class="bg-gray-700 ${selected ? 'text-primary-dark bg-gray-200' : 'text-light-text'} px-2 py-0.5 rounded-full font-bold">${w.type}</span>
                                            <span class="font-medium ${selected ? 'text-primary-dark/80' : 'text-gray-300'}">${w.difficulty} | ${w.duration}</span>
                                        </div>
                                    </div>
                                    <div class="p-2 ${iconColor} flex-shrink-0">
                                        <i class="${selected ? 'fas fa-check-circle' : 'fas fa-circle-plus'} text-2xl"></i>
                                    </div>
                                </div>
                                <p class="text-sm mt-3 ${selected ? 'text-primary-dark/90' : 'text-gray-400'} italic">
                                    ${w.description.substring(0, 80)}...
                                </p>
                            </div>
                        </div>
                        <div id="details-${w.id}" class="${isExpanded ? 'max-h-expand' : 'max-h-collapse'} overflow-hidden">
                            ${detailsHtml}
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="toggleWorkoutDetails('${w.id}')" class="text-sm font-semibold py-1 px-3 rounded-full transition duration-150 
                                ${selected ? 'bg-primary-dark/10 text-primary-dark hover:bg-primary-dark/30' : 'bg-gray-700 text-accent-cyan hover:bg-gray-600'}">
                                <i class="fas ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'} mr-1"></i> 
                                ${isExpanded ? 'Show Less Details' : 'Expand Full Workout'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };


        const initializeFilters = () => {
            const filterContainer = document.getElementById('modalFilterContainer');
            const types = getWorkoutTypes();


            filterContainer.innerHTML = types.map(type => `
                <button
                    onclick="setFilter('${type}')"
                    class="filter-btn text-sm px-4 py-2 rounded-full font-bold transition duration-150 ${selectedFilter === type ? 'bg-accent-cyan text-primary-dark shadow-xl' : 'bg-gray-700 text-light-text hover:bg-gray-600'}"
                >
                    ${type}
                </button>
            `).join('');
        };


        const setFilter = (type) => {
            selectedFilter = type;
            expandedWorkoutId = null; 
            initializeFilters(); 
            renderWorkoutList();
        };


        // --- Other Utility Functions (clearPlan, executeAutoFill, generateChallengeDocument) ---
        
        /** Clears the entire challenge plan. */
        const clearPlan = () => {
            const confirmationModal = document.getElementById('confirmationModal');
            document.getElementById('confirmAction').onclick = () => {
                challengePlan = Array.from({ length: DAYS_IN_CHALLENGE }, () => []);
                localStorage.removeItem(PLAN_STORAGE_KEY);
                renderChallengeGrid();
                confirmationModal.classList.add('hidden');
            };
            document.getElementById('cancelAction').onclick = () => {
                confirmationModal.classList.add('hidden');
            };
            document.getElementById('modalMessage').textContent = 'Are you sure you want to clear the entire 4-week challenge plan?';
            document.getElementById('confirmAction').classList.remove('hidden'); 
            document.getElementById('cancelAction').textContent = 'Cancel'; 
            confirmationModal.classList.add('hidden'); // Fix: Should be hidden initially, but removed during confirmation flow
            confirmationModal.classList.remove('hidden'); // Show it now
        };

        
        /** Executes the auto-fill based on the goal using the user-provided schedules. */
        const executeAutoFill = () => {
            const goal = document.querySelector('input[name="goal"]:checked')?.value;
            const difficulty = document.querySelector('input[name="difficulty"]:checked')?.value;
            
            if (!goal || !difficulty) {
                console.error("Goal or Difficulty not selected.");
                return;
            }
            
            // --- Workout ID Mappings based on new 6 Workouts ---
            const HIWT_ID = 'w1';           // High Intensity Weight Training
            const HIIT_ID = 'w2';           // HIIT Cardio Blast
            const CORE_STATIC_ID = 'w3';    // CORE
            const ABS_DYNAMIC_ID = 'w4';    // ABS
            const MUSCLE_BUILDING_ID = 'w5';// MUSCLE BUILDING
            const REST_ID = 'w6';           // Rest
            
            
            // Helper to get the correct version (IGNORED FOR NOW, as we only have 1 version of each)
            const getWorkoutIdByDifficulty = (baseName, difficulty) => {
                const map = {
                    'HIWT': HIWT_ID,
                    'HIIT': HIIT_ID,
                    'CORE': CORE_STATIC_ID,
                    'ABS': ABS_DYNAMIC_ID,
                    'MUSCLE_BUILDING': MUSCLE_BUILDING_ID,
                    'REST': REST_ID,
                };
                return map[baseName] || null;
            }


            // Variable to cycle between CORE/ABS
            let coreCycle = 0; 
            
            for (let i = 0; i < DAYS_IN_CHALLENGE; i++) {
                const dayOfWeek = i % 7; // 0=Mon, 1=Tue, ..., 6=Sun
                
                let workoutsForDay = [];
                let hiwtWorkout, hiitWorkout, coreWorkout, absWorkout, muscleBuilding;

                // Map IDs for clarity
                hiwtWorkout = HIWT_ID;
                hiitWorkout = HIIT_ID;
                coreWorkout = CORE_STATIC_ID;
                absWorkout = ABS_DYNAMIC_ID;
                muscleBuilding = MUSCLE_BUILDING_ID;


                switch (goal) {
                    case 'Weight Loss':
                        // Focus on high calorie burn (HIIT, HIWT) and Core/ABS rotation
                        coreWorkout = coreCycle % 2 === 0 ? CORE_STATIC_ID : ABS_DYNAMIC_ID;

                        switch (dayOfWeek) {
                            case 0: // Mon: HIWT + Core/ABS
                                workoutsForDay = [hiwtWorkout, coreWorkout];
                                coreCycle++;
                                break;
                            case 1: // Tue: HIIT
                                workoutsForDay = [hiitWorkout];
                                break;
                            case 2: // Wed: HIWT + Core/ABS
                                workoutsForDay = [hiwtWorkout, coreWorkout];
                                coreCycle++;
                                break;
                            case 3: // Thu: Core/ABS (Active Recovery)
                                workoutsForDay = [coreWorkout];
                                break;
                            case 4: // Fri: HIIT
                                workoutsForDay = [hiitWorkout];
                                break;
                            case 5: // Sat: HIWT 
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 6: // Sun: Rest
                                workoutsForDay = [REST_ID];
                                break;
                        }
                        break;

                    case 'Muscle Building':
                        // Focus on hypertrophy (Muscle Building) and strength endurance (HIWT)
                        
                        switch (dayOfWeek) {
                            case 0: // Mon: MUSCLE BUILDING
                                workoutsForDay = [muscleBuilding]; 
                                break;
                            case 1: // Tue: HIWT (Strength Endurance)
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 2: // Wed: ABS
                                workoutsForDay = [absWorkout]; 
                                break;
                            case 3: // Thu: Rest
                                workoutsForDay = [REST_ID];
                                break;
                            case 4: // Fri: MUSCLE BUILDING
                                workoutsForDay = [muscleBuilding];
                                break;
                            case 5: // Sat: HIWT (Strength Endurance)
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 6: // Sun: CORE
                                workoutsForDay = [coreWorkout];
                                break;
                        }
                        break;
                        
                    case 'Maintenance':
                        // Balanced approach
                        
                        switch (dayOfWeek) {
                            case 0: // Mon: HIWT 
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 1: // Tue: CORE
                                workoutsForDay = [coreWorkout];
                                break;
                            case 2: // Wed: HIIT 
                                workoutsForDay = [hiitWorkout];
                                break;
                            case 3: // Thu: ABS
                                workoutsForDay = [absWorkout];
                                break;
                            case 4: // Fri: HIWT 
                                workoutsForDay = [hiwtWorkout];
                                break;
                            case 5: // Sat: HIIT 
                                workoutsForDay = [hiitWorkout];
                                break;
                            case 6: // Sun: Rest
                                workoutsForDay = [REST_ID];
                                break;
                        }
                        break;

                    default:
                        // Fallback: clear the day
                        workoutsForDay = [];
                        break;
                }

                // Filter out any potential duplicates or null/undefined entries
                challengePlan[i] = workoutsForDay.filter(id => id && getWorkoutById(id));
            }
            
            renderChallengeGrid();
            savePlan();
            closeAutoFillOptions();
        };


        const generateChallengeDocument = () => {
            let docContent = ``;


            // 1. Data Gathering for Document
            const scheduledWorkoutIds = new Set();
            challengePlan.flat().forEach(id => {
                if (id) scheduledWorkoutIds.add(id);
            });


            const uniqueWorkouts = Array.from(scheduledWorkoutIds).map(id => getWorkoutById(id)).filter(w => w !== undefined);
            
            // 2. Section 1: Schedule Grid 
            let scheduleHtml = `<h2 style="color: #1f2937; margin-top: 1.5rem; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem;">1. 4-Week Challenge Schedule</h2>`;
            scheduleHtml += `<p style="color: #4b5563; font-size: 1rem; margin-bottom: 20px;">This is the high-level view of your 28-day challenge plan, showing the scheduled workouts for each day.</p>`;
            scheduleHtml += `<table style="width: 100%; border-collapse: collapse; margin-top: 15px; text-align: left; font-size: 0.9rem;">`;
            scheduleHtml += `<thead><tr>`;
            const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            daysOfWeek.forEach(day => {
                scheduleHtml += `<th style="background-color: #f3f4f6; padding: 10px; border: 1px solid #d1d5db; color: #1f2937; text-align: center;">${day}</th>`;
            });
            scheduleHtml += `</tr></thead><tbody>`;


            for (let week = 0; week < 4; week++) {
                scheduleHtml += `<tr>`;
                for (let day = 0; day < 7; day++) {
                    const index = week * 7 + day;
                    const workoutIds = challengePlan[index];
                    const workouts = workoutIds.map(id => getWorkoutById(id)).filter(w => w !== undefined);
                    
                    let cellContent = '';
                    if (workouts.length > 0) {
                        cellContent = workouts.map(w => `<span style="font-weight: bold; color: ${w.type === 'REST' ? '#dc2626' : '#14b8a6'};">${w.name}</span><br><span style="font-size: 0.9em; color: #6b7280;">(${w.type})</span>`).join('<hr style="margin: 4px 0; border-top: 1px dashed #e5e7eb;">');
                    } else {
                        cellContent = '<span style="color: #9ca3af; font-style: italic;">Unplanned</span>';
                    }
                    
                    scheduleHtml += `<td style="padding: 10px; border: 1px solid #d1d5db; vertical-align: top; background-color: ${day % 2 === 0 ? '#f9fafb' : '#ffffff'};">
                        <span style="font-weight: bold; color: #374151; font-size: 0.85rem;">W${week + 1} | Day ${day + 1}</span>
                        <div style="margin-top: 5px;">${cellContent}</div>
                    </td>`;
                }
                scheduleHtml += `</tr>`;
            }


            scheduleHtml += `</tbody></table>`;
            docContent += scheduleHtml;
            docContent += `<hr style="margin: 2.5rem 0; border: none; border-top: 3px double #e5e7eb;">`;


            // 3. Section 2: Detailed Workouts 
            // NOTE: Updated the description text here to reflect a single image
            let workoutDetailsHtml = `<h2 style="color: #1f2937; margin-top: 1.5rem; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem;">2. Detailed Workout Descriptions</h2>`;
            workoutDetailsHtml += `<p style="color: #4b5563; font-size: 1rem; margin-bottom: 20px;">Below are the complete details for every unique workout in your plan, including a single reference image.</p>`;


            uniqueWorkouts.forEach((w) => {
                // Use the single documentImage field
                const largeImageSrc = w.documentImage || DEFAULT_LARGE_IMAGE_URL;


                workoutDetailsHtml += `
                    <div style="border: 1px solid #d1d5db; border-radius: 12px; padding: 20px; margin-bottom: 25px; background-color: #f9fafb; box-shadow: 0 4px 6px rgba(0,0,0,0.05); page-break-inside: avoid;">
                        
                        <!-- REMOVED THE SECOND IMAGE CONTAINER - NOW ONLY ONE REMAINS -->
                        <div style="width: 100%; margin-bottom: 20px; text-align: center;">
                            <p style="font-weight: bold; margin-bottom: 5px; color: #374151; font-size: 0.9rem;">Instructional/Reference Image</p>
                            <img src="${largeImageSrc}" alt="${w.name} guide" onerror="this.onerror=null; this.src='${DEFAULT_LARGE_IMAGE_URL}'" 
                                 style="width: 100%; height: auto; border-radius: 8px; border: 1px solid #a1a1aa; max-height: 400px; object-fit: cover; max-width: 500px; margin: 0 auto; display: block;">
                        </div>


                        <h3 style="margin-top: 0; margin-bottom: 5px; color: #1f2937; font-size: 1.4rem; font-weight: bold;">${w.name}</h3>
                        <p style="margin-top: 0; color: #6b7280; font-size: 0.9rem; line-height: 1.4;">
                            <strong style="color: #14b8a6;">Type:</strong> ${w.type} | 
                            <strong style="color: #14b8a6;">Duration:</strong> ${w.duration} | 
                            <strong style="color: #14b8a6;">Difficulty:</strong> ${w.difficulty}
                        </p>
                        
                        <h4 style="margin-top: 15px; color: #374151; font-size: 1.1rem; font-weight: bold;">Description:</h4>
                        <p style="color: #4b5563; font-size: 0.95rem; margin-top: 5px; white-space: pre-wrap;">${w.description}</p>


                        <h4 style="margin-top: 15px; color: #374151; font-size: 1.1rem; font-weight: bold;">Structure:</h4>
                        <p style="color: #4b5563; font-size: 0.95rem; margin-top: 5px; white-space: pre-wrap;">${w.structure}</p>


                        <h4 style="margin-top: 15px; color: #374151; font-size: 1.1rem; font-weight: bold;">Tips:</h4>
                        <p style="color: #4b5563; font-size: 0.95rem; margin-top: 5px; white-space: pre-wrap;">${w.tips}</p>


                    </div>
                `;
            });


            docContent += workoutDetailsHtml;
            docContent += `<p style="margin-top: 40px; text-align: center; color: #9ca3af;">— End of Challenge Document —</p>`;




            // 4. Final Output to Print Window
            const w = window.open();
            w.document.write(`
                <html class="p-8 font-sans">
                    <head>
                        <title>4-Week Challenge Document</title>
                        <style>
                            /* Styles for the print view */
                            body { max-width: 850px; margin: auto; line-height: 1.6; font-family: 'Inter', sans-serif; padding: 30px; }
                            h1 { font-size: 2.5rem; color: #14b8a6; text-align: center; margin-bottom: 10px;} 
                            h2 { font-size: 1.5rem; color: #1f2937; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3rem; }
                            h3 { font-size: 1.4rem; color: #374151; margin-top: 0; }
                            h4 { font-size: 1.1rem; color: #4b5563; font-weight: bold; }
                            p, ul, li { font-size: 1rem; color: #4b5563; }
                            
                            .print-button { 
                                margin-top: 2rem; padding: 0.75rem 1.5rem; 
                                background-color: #14b8a6; color: white; 
                                font-weight: bold; border-radius: 0.5rem; cursor: pointer; border: none; 
                                display: block; width: 250px; margin-left: auto; margin-right: auto; text-align: center;
                                text-decoration: none;
                            }
                            @media print { .print-button { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1>🏋️ 4-Week Home Workout Challenge Plan</h1>
                        <p style="text-align: center; color: #6b7280; margin-bottom: 30px;">Your complete 28-day fitness schedule, designed for easy tracking and reference.</p>
                        <a href="#" class="print-button" onclick="window.print(); return false;">Print Challenge Document</a>
                        ${docContent}
                        <a href="#" class="print-button" onclick="window.print(); return false;">Print Challenge Document</a>
                    </body>
                </html>
            `);
            w.document.close();
        };


        const openAutoFillOptions = () => {
            document.getElementById('autoFillOptionsModal').classList.remove('hidden');
            // Ensure one option is checked by default if none are
            if (!document.querySelector('input[name="goal"]:checked')) {
                document.querySelector('input[name="goal"][value="Weight Loss"]').checked = true;
            }
            if (!document.querySelector('input[name="difficulty"]:checked')) {
                document.querySelector('input[name="difficulty"][value="Intermediate"]').checked = true;
            }
        };


        const closeAutoFillOptions = () => {
            document.getElementById('autoFillOptionsModal').classList.add('hidden');
        };


        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Replaced initFirebase with local storage load and render
            loadPlan(); 
            renderApp(); 


            // Global buttons
            document.getElementById('autoFillBtn').addEventListener('click', openAutoFillOptions); 
            document.getElementById('clearPlanBtn').addEventListener('click', clearPlan);
            document.getElementById('generatePrintBtn').addEventListener('click', generateChallengeDocument);


            // Listeners for Modals
            document.getElementById('workoutSelectionModal').addEventListener('click', (e) => {
                if (e.target.id === 'workoutSelectionModal' || e.target.closest('#modalCloseBtn')) {
                    closeWorkoutSelection();
                }
            });
            document.getElementById('confirmSelectionBtn').addEventListener('click', confirmSelection);
            
            document.getElementById('autoFillOptionsModal').addEventListener('click', (e) => {
                 if (e.target.id === 'autoFillOptionsModal' || e.target.closest('#autoFillCloseBtn')) {
                    closeAutoFillOptions();
                }
            });
            document.getElementById('executeAutoFillBtn').addEventListener('click', executeAutoFill);
        });


        // Expose functions for inline onclick/script access
        window.clearPlan = clearPlan;
        window.setFilter = setFilter;
        window.toggleWorkoutSelection = toggleWorkoutSelection;
        window.toggleWorkoutDetails = toggleWorkoutDetails;
        window.closeWorkoutSelection = closeWorkoutSelection;
        window.executeAutoFill = executeAutoFill; 
        
        // Custom Modal for non-alert confirmation (for clearPlan)
        document.write(`
            <div id="confirmationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
                <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <p id="modalMessage" class="text-light-text text-lg mb-6"></p>
                    <div class="flex justify-end space-x-4">
                        <button id="cancelAction" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            Cancel
                        </button>
                        <button id="confirmAction" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
        `);
    </script>
    
    


<style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: #f3f4f6;
        }
        .challenge-cell {
            min-height: 120px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #374151;
        }
        .challenge-cell:hover {
            border-color: #06b6d4;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.4);
        }
        .workout-card {
            transition: background-color 0.1s;
        }
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
        /* Custom classes for smooth height transitions */
        .max-h-expand {
            max-height: 1000px; /* Sufficiently large value */
            transition: max-height 0.4s ease-in-out;
        }
        .max-h-collapse {
            max-height: 0;
            transition: max-height 0.4s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-primary-dark">


    <div id="appContainer">
        
        


<header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-accent-teal mb-2">4-Week Home Workout Challenge Builder</h1>
            <p class="text-lg text-gray-300">Your personalized, local fitness plan generator.</p>
        </header>


        


<div id="scheduleView" class="lg:w-full">
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="autoFillBtn" class="flex-1 min-w-[150px] bg-accent-teal hover:bg-teal-600 text-primary-dark font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    <i class="fas fa-magic mr-2"></i> Auto-Fill Challenge
                </button>
                <button id="clearPlanBtn" class="flex-1 min-w-[150px] bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    <i class="fas fa-trash mr-2"></i> Clear Plan
                </button>
                <button id="generatePrintBtn" class="flex-1 min-w-[150px] bg-accent-cyan hover:bg-cyan-600 text-primary-dark font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    <i class="fas fa-file-alt mr-2"></i> Create Challenge Document
                </button>
            </div>
    
            <div class="bg-secondary-dark p-4 md:p-6 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-bold text-light-text mb-4">Your 28-Day Schedule</h2>
                <div id="challengeGrid" class="grid grid-cols-7 gap-3">
                    <p class="col-span-7 text-center text-gray-400">Loading workouts...</p>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Workout Selection Modal (Used in Schedule View) -->
    <div id="workoutSelectionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-primary-dark p-6 rounded-xl shadow-2xl w-full max-w-4xl h-[90%] overflow-y-auto border border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3 sticky top-0 bg-primary-dark z-10">
                <h2 id="modalTitle" class="text-3xl font-extrabold text-accent-teal">Edit Workouts</h2>
                <button id="modalCloseBtn" class="text-gray-400 hover:text-red-500 transition duration-150">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>


            <div id="modalFilterContainer" class="flex flex-wrap gap-2 mb-6 sticky top-[80px] bg-primary-dark py-2 border-b border-gray-800 z-10">
                <!-- Filters will be rendered here -->
            </div>


            <div id="modalWorkoutList" class="custom-scroll flex-grow overflow-y-auto pr-4">
                <!-- Workout list will be rendered here -->
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-700 sticky bottom-0 bg-primary-dark z-10">
                <button id="confirmSelectionBtn" class="w-full bg-accent-cyan hover:bg-cyan-600 text-primary-dark font-extrabold py-3 rounded-xl shadow-lg transition duration-200">
                    <i class="fas fa-save mr-2"></i> Confirm Selection
                </button>
            </div>
        </div>
    </div>
    
    <!-- Auto-Fill Options Modal (Used in Schedule View) -->
    <div id="autoFillOptionsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700">
            
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                <h2 class="text-3xl font-extrabold text-accent-teal"><i class="fas fa-magic mr-2"></i> Auto-Fill Options</h2>
                <button id="autoFillCloseBtn" class="text-gray-400 hover:text-red-500 transition duration-150">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>


            <div class="mb-6">
                <h3 class="text-xl font-semibold text-light-text mb-3">1. Select Your Primary Goal</h3>
                <div class="flex flex-wrap gap-3">
                    <label class="flex-1">
                        <input type="radio" name="goal" value="Weight Loss" class="hidden peer" checked>
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-teal peer-checked:border-accent-teal peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Weight Loss
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="goal" value="Muscle Building" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-teal peer-checked:border-accent-teal peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Muscle Building
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="goal" value="Maintenance" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-teal peer-checked:border-accent-teal peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Maintenance
                        </div>
                    </label>
                </div>
            </div>


            <div class="mb-8">
                <h3 class="text-xl font-semibold text-light-text mb-3">2. Select Your Experience Level</h3>
                <div class="flex flex-wrap gap-3">
                    <label class="flex-1">
                        <input type="radio" name="difficulty" value="Beginner" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-cyan peer-checked:border-accent-cyan peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Beginner
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="difficulty" value="Intermediate" class="hidden peer" checked>
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-cyan peer-checked:border-accent-cyan peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Intermediate
                        </div>
                    </label>
                    <label class="flex-1">
                        <input type="radio" name="difficulty" value="Advanced" class="hidden peer">
                        <div class="p-4 rounded-xl border-2 border-gray-600 bg-primary-dark text-center cursor-pointer peer-checked:bg-accent-cyan peer-checked:border-accent-cyan peer-checked:text-primary-dark font-bold transition duration-200 shadow-lg">
                            Advanced
                        </div>
                    </label>
                </div>
            </div>


            <button id="executeAutoFillBtn" class="w-full bg-accent-teal hover:bg-teal-600 text-primary-dark font-extrabold py-3 rounded-xl shadow-lg transition duration-200">
                Generate 4-Week Plan
            </button>
        </div>
    </div>
    
</body>
</html>